#!/bin/bash
set -x
{% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = ansible_default_ipv4.address, 6443 %}
{% if inventory_hostname in groups['master'] %}
  {% if IP_STACK | default("ipv4") == "ipv6" %}
    {% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = ansible_default_ipv6.address, 6443 %}
  {% else %}
    {% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = ansible_default_ipv4.address, 6443 %}
  {% endif %}
{% else %}
  {% if ha.type == "none" %}
    {% if IP_STACK | default("ipv4") == "ipv6" %}
      {% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = {{ hostvars[groups['master'][0]]['ansible_facts']['default_ipv6']['address'] }}, 6443 %}
    {% else %}
      {% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = {{ hostvars[groups['master'][0]]['ansible_facts']['default_ipv4']['address'] }}, 6443 %}
    {% endif %}
  {% else %}
    {% if ha.type == "slb" %}
      {% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = ha.vip, 8443 %}
    {% else %}
      {% set KUBE_APISERVER_ADDR, KUBE_APISERVER_PORT = ha.vip, 6443 %}
    {% endif %}
  {% endif %}
{% endif %}

/usr/bin/chronyc -n makestep
{% if IP_STACK | default("ipv4") == "ipv6" %}
creationTimestamp=$(curl -s --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/kubelet.crt --key /etc/kubernetes/pki/kubelet.key https://[{{ KUBE_APISERVER_ADDR }}]:{{ KUBE_APISERVER_PORT }}/api/v1/nodes/{{ ansible_hostname | lower }} | jq -r '.metadata.creationTimestamp')
{% else %}
creationTimestamp=$(curl -s --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/kubelet.crt --key /etc/kubernetes/pki/kubelet.key https://{{ KUBE_APISERVER_ADDR }}:{{ KUBE_APISERVER_PORT }}/api/v1/nodes/{{ ansible_hostname | lower }} | jq -r '.metadata.creationTimestamp')
{% endif %}
difference=$(($(date +%s) - $(date -d "${creationTimestamp}" +%s)))
if [ $((difference / 60)) -gt 60 ];then
  echo "Node up time > 60m, check"
  retry=0
  for ((i = 1; i <= 5; i++)); do
    {% if IP_STACK | default("ipv4") == "ipv6" %}
    nodeStats=$(curl -s --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/kubelet.crt --key /etc/kubernetes/pki/kubelet.key https://[{{ KUBE_APISERVER_ADDR }}]:{{ KUBE_APISERVER_PORT }}/api/v1/nodes/{{ ansible_hostname | lower }} | jq -r '.status.conditions[] | select(.type=="Ready")| .status')
    {% else %}
    nodeStats=$(curl -s --cacert /etc/kubernetes/pki/ca.crt --cert /etc/kubernetes/pki/kubelet.crt --key /etc/kubernetes/pki/kubelet.key https://{{ KUBE_APISERVER_ADDR }}:{{ KUBE_APISERVER_PORT }}/api/v1/nodes/{{ ansible_hostname | lower }} | jq -r '.status.conditions[] | select(.type=="Ready")| .status')
    {% endif %}
    if [ ${nodeStats} == "True" ]; then
      break
    fi
    echo "Check node status is not 'True', restart kubelet services, retry: ${i}."
    systemctl restart kubelet.service
    sleep 10
  done
else
  echo "Node up time < 60m, skip"
fi