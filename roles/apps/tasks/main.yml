---
# tasks file for apps
- block:
    - name: Create application directory
      ansible.builtin.file:
        name: '{{ apps.location | default("/etc/kubernetes/apps") }}'
        state: directory
        mode: "0755"

    - name: Download manifest to the cluster
      get_url:
        url: "{{ item.url }}"
        dest: '{{ apps.location | default("/etc/kubernetes/apps") }}/{{ item.name }}'
      with_items: "{{ apps.files }}"
      register: manifests
      until: manifests is succeeded
      retries: 10
      environment: "{{ proxy_env | default({'http_proxy': '', 'https_proxy': '', 'no_proxy': ''}) }}"

    - name: Apply manifest to the cluster
      kubernetes.core.k8s:
        state: present
        src: "{{ apps.location | default('/etc/kubernetes/apps') }}/{{ item.name }}"
      run_once: true
      with_items: "{{ apps.files }}"
  when: apps is defined
